# 뽑기(Gacha) 시스템 사양서

## 뽑기 시스템 개요

Castle Defense의 뽑기 시스템은 플레이어가 젬(Gem)을 소모하여 무작위 캐릭터를 획득하는 시스템입니다. 확률 기반으로 다양한 랭크의 캐릭터를 획득할 수 있습니다.

## 뽑기 화폐

### 젬 (Gem) 💎
- 뽑기 전용 화폐
- 획득 방법:
  - 라운드 클리어 보상
  - 퀘스트 완료
  - 상점 구매 (예정)
  - 이벤트 보상

## 뽑기 종류

### 1. 단일 소환 (Single Summon)

#### 비용
- 젬 100개

#### 특징
- 캐릭터 1명 획득
- 일반 확률 적용
- 보장 없음

#### 확률
- S 랭크: 3%
- A 랭크: 12%
- B 랭크: 35%
- C 랭크: 50%

### 2. 10연차 소환 (10-Pull Summon)

#### 비용
- 젬 900개 (10% 할인)
- 단일 소환 10회 대비 100젬 할인

#### 특징
- 캐릭터 10명 획득
- **보장 시스템**: 최소 1명 이상 A 랭크 이상 확정

#### 확률
- 처음 9명: 일반 확률
  - S: 3%, A: 12%, B: 35%, C: 50%
- 마지막 1명: **A 랭크 이상 보장**
  - 일반 확률로 뽑았을 때 C/B가 나오면 → A로 강제 변경
  - S가 나오면 그대로 S 유지
  - A가 나오면 그대로 A 유지

## 확률 시스템

### 확률 분포
```
S 랭크:  3% ████
A 랭크: 12% ████████████████
B 랭크: 35% ████████████████████████████████████████
C 랭크: 50% ████████████████████████████████████████████████████
         0%                                                  100%
```

### 확률 계산 방식
```dart
// 누적 확률 방식
roll = random(0.0 ~ 1.0)

if (roll < 0.03)        // 0.00 ~ 0.03
  → S 랭크 (3%)
else if (roll < 0.15)   // 0.03 ~ 0.15
  → A 랭크 (12%)
else if (roll < 0.50)   // 0.15 ~ 0.50
  → B 랭크 (35%)
else
  → C 랭크 (50%)
```

### 10연차 마지막 보장 로직
```dart
// 마지막 1개 뽑기
lastRank = determineRank()

// C 또는 B가 나오면 A로 변경
if (lastRank == C || lastRank == B) {
  guaranteedRank = A
} else {
  guaranteedRank = lastRank  // S나 A는 그대로 유지
}
```

## 뽑기 결과 처리

### 랭크 결정 후 캐릭터 선택
1. 랭크가 결정됨 (예: S 랭크)
2. 해당 랭크의 모든 캐릭터 목록 조회
3. 무작위로 1명 선택

### 랭크별 캐릭터 풀
- S 랭크: 8명
- A 랭크: 4명
- B 랭크: 3명
- C 랭크: 2명

### 중복 획득
- 중복 캐릭터 획득 가능
- 각 획득마다 고유 인스턴스 생성
- 인스턴스 ID: `{characterId}_{timestamp}`

## 뽑기 UI 흐름

### 1. 뽑기 메인 화면
```
┌─────────────────────────────────────┐
│  🎰 소환  |  💎 500                 │
├─────────────────────────────────────┤
│  [단일 소환 100💎] [10연차 900💎]   │
│                                     │
│  S:3% A:12% B:35% C:50%            │
├─────────────────────────────────────┤
│  📖 캐릭터 도감                      │
│  보유: 5 / 17                       │
│                                     │
│  ┌──┬──┬──┬──┬──┐                 │
│  │S │A │B │🔒│🔒│                 │
│  ├──┼──┼──┼──┼──┤                 │
│  │🔒│🔒│🔒│🔒│🔒│                 │
│  └──┴──┴──┴──┴──┘                 │
└─────────────────────────────────────┘
```

### 2. 버튼 클릭 시
- 젬 부족 확인
  - 부족하면: 버튼 비활성화 (회색)
  - 충분하면: 뽑기 실행
- 젬 차감
- 뽑기 결과 생성
- 결과 화면으로 전환

### 3. 결과 화면 (단일)
```
┌─────────────────────────────────────┐
│                                     │
│         ┌─────────────┐             │
│         │             │             │
│         │   [캐릭터   │             │
│         │    이미지]  │             │
│         │             │             │
│         └─────────────┘             │
│                                     │
│      S 랭크 🛡️ 바르그              │
│                                     │
│       터치하여 계속                  │
└─────────────────────────────────────┘
```

### 4. 결과 화면 (10연차)
```
화면 1: [캐릭터 1]
   ↓ (터치)
화면 2: [캐릭터 2]
   ↓ (터치)
...
화면 10: [캐릭터 10]
   ↓ (터치)
→ 도감으로 복귀 (모두 인벤토리에 추가됨)
```

### 5. 인벤토리 추가
- 모든 결과 확인 완료 후
- 획득한 캐릭터를 `ownedCharacters`에 추가
- 도감 UI 자동 업데이트

## 캐릭터 도감 (Collection)

### 레이아웃
```
┌──┬──┬──┬──┬──┐
│01│02│03│04│05│  ← 한 행에 5개
├──┼──┼──┼──┼──┤
│06│07│08│09│10│
├──┼──┼──┼──┼──┤
│11│12│13│14│15│
├──┼──┼──┼──┼──┤
│16│17│  │  │  │
└──┴──┴──┴──┴──┘
   ↑ 총 17개 캐릭터
```

### 보유 캐릭터 표시
```
┌─────────┐
│    S    │  ← 랭크 (금색)
│   🛡️   │  ← 역할 이모지
│  바르그  │  ← 캐릭터 이름
│   x16   │  ← 중복 개수 (빨간 배지)
└─────────┘
```

- 배경: 흰색
- 랭크 색상: S(금), A(은), B(동), C(회색)
- 역할 이모지: 🛡️⚔️🔮✝️🛠️
- 중복 개수: 2개 이상일 때만 표시

### 미보유 캐릭터 표시
```
┌─────────┐
│   🔒   │  ← 잠금 아이콘
│        │
│  ???   │  ← 물음표
│        │
└─────────┘
```

- 배경: 회색 (0xFFBDBDBD)
- 텍스트: 어두운 회색
- 정보 숨김

### 스크롤 기능
- 방식: 드래그 스크롤
- 영역: 캐릭터 리스트 전체 (345px 높이)
- 최대 스크롤: 동적 계산
  ```dart
  maxScroll = (총 행 수 × (카드 높이 + 간격)) - 표시 영역 높이
  ```
- 스크롤 인디케이터: 우측에 표시

## 뽑기 애니메이션 (예정)

### 뽑기 연출
1. **버튼 클릭**
   - 버튼 클릭 효과
   - 젬 차감 애니메이션

2. **소환 연출**
   - 화면 전환 (페이드 아웃)
   - 뽑기 문 열림 효과
   - 빛 효과

3. **랭크 공개**
   - 랭크 색상 빛 효과
   - S/A 랭크: 특수 효과 (반짝임)
   - 카드 뒤집기 애니메이션

4. **캐릭터 공개**
   - 캐릭터 이미지 등장
   - 이름/정보 페이드 인
   - 배경 효과

### 10연차 연출
- 옵션 1: 한 번에 10개 카드 표시
- 옵션 2: 1개씩 순차 공개 (현재 적용)
- S 랭크: 특별 효과 강조

## 뽑기 시스템 코드 구조

### GachaSystem 클래스
```dart
class GachaSystem {
  // 단일 뽑기
  CharacterDefinition summonOne()

  // 10연차 뽑기
  List<CharacterDefinition> summonTen()

  // 랭크 결정 (내부)
  RankType _determineRank()

  // 비용 조회
  int getSingleSummonCost()  // 100
  int getTenSummonCost()     // 900
}
```

### CharacterDefinitions 클래스
```dart
class CharacterDefinitions {
  // 전체 캐릭터 목록
  static final List<CharacterDefinition> all

  // ID로 조회
  static CharacterDefinition byId(String id)

  // 랭크로 필터
  static List<CharacterDefinition> byRank(RankType rank)

  // 안전 조회
  static CharacterDefinition? tryById(String id)
}
```

### 뽑기 데이터 흐름
```
사용자 터치
    ↓
젬 확인 & 차감
    ↓
GachaSystem.summonOne/Ten()
    ↓
랭크 결정 (_determineRank)
    ↓
해당 랭크 캐릭터 풀 조회
    ↓
무작위 선택
    ↓
결과 저장 (gachaResults)
    ↓
결과 화면 렌더링
    ↓
사용자 터치로 진행
    ↓
인벤토리에 추가 (ownedCharacters)
```

## 통계 시스템 (예정)

### 뽑기 이력
- 총 뽑기 횟수
- 랭크별 획득 통계
- 천장 시스템 (pity system)

### 천장 시스템 (미구현)
- N회 뽑기 시 S 랭크 보장
- 카운터 리셋 조건
- 보장 확률 증가

## 뽑기 확률 검증

### 기대값 계산 (단일 뽑기)
```
S 랭크: 3%   → 100회 중 약 3회
A 랭크: 12%  → 100회 중 약 12회
B 랭크: 35%  → 100회 중 약 35회
C 랭크: 50%  → 100회 중 약 50회
```

### 기대값 계산 (10연차)
```
처음 9회:
  S: 9 × 0.03 = 0.27회
  A: 9 × 0.12 = 1.08회
  B: 9 × 0.35 = 3.15회
  C: 9 × 0.50 = 4.50회

마지막 1회 (보장):
  최소 A 랭크 이상

총 기대값 (10연차):
  S: 약 0.27회
  A: 약 1.08 + α회 (보장 포함)
  B: 약 3.15회
  C: 약 4.50회
```

### 10연차 보장 효과
- C/B 확률(85%) 발생 시 → A로 승급
- 실질적으로 A 이상 획득률: 약 25% → 100% (마지막 1회)

## 뽑기 비용 효율

### 비용 비교
- 단일 소환 × 10: 1000젬
- 10연차 소환: 900젬
- **할인율: 10%**

### 추가 혜택
- 10연차: A 랭크 이상 보장 (가치 증가)
- 단일: 보장 없음

## UI/UX 개선 사항

### 현재 구현
- 압축된 헤더 레이아웃
- 넓은 스크롤 영역 (345px)
- 중복 개수 표시
- 직관적인 보유/미보유 구분

### 향후 개선 (예정)
- 캐릭터 상세 정보 팝업
- 필터 기능 (랭크별, 역할별)
- 정렬 기능 (획득순, 랭크순, 이름순)
- 검색 기능
- 뽑기 이력 조회
- 애니메이션 효과 추가
